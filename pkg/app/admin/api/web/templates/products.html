{{ define "title" }}Products{{ end }} {{ define "content" }}
<style>
  form#upload-form {
    max-width: 480px;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin-bottom: 2rem;
  }

  form#upload-form label {
    font-weight: 600;
    font-size: 1.1rem;
    color: #27272a;
  }

  form#upload-form input[type="file"] {
    padding: 0.4rem;
    border-radius: 6px;
    border: 1.8px solid #cbd5e1;
    transition: border-color 0.3s ease;
  }

  form#upload-form input[type="file"]:focus {
    outline: none;
    border-color: #6366f1;
    box-shadow: 0 0 6px rgba(99, 102, 241, 0.5);
  }

  form#upload-form button {
    align-self: start;
    background-color: #6366f1;
    color: white;
    font-weight: 700;
    border: none;
    border-radius: 8px;
    padding: 0.7rem 1.8rem;
    cursor: pointer;
    font-size: 1.125rem;
    transition: background-color 0.3s ease;
  }

  form#upload-form button:hover,
  form#upload-form button:focus {
    background-color: #4f46e5;
    outline: none;
  }

  ul#product-list {
    list-style: none;
    max-width: 720px;
  }

  ul#product-list li {
    background: white;
    border-radius: 12px;
    padding: 1.5rem 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 8px rgb(0 0 0 / 0.1);
  }

  ul#product-list h3 {
    font-size: 1.8rem;
    margin-bottom: 0.3rem;
    color: #27272a;
    font-weight: 700;
  }

  ul#product-list p {
    margin-bottom: 1rem;
    color: #475569;
    font-size: 1rem;
    line-height: 1.4;
  }

  ul#product-list img {
    max-width: 180px;
    border-radius: 8px;
    margin-bottom: 1rem;
    object-fit: contain;
  }

  ul#product-list ul {
    padding-left: 1.25rem;
    margin-bottom: 1rem;
    color: #334155;
  }

  ul#product-list ul li {
    margin-bottom: 0.35rem;
  }

  ul#product-list ul li strong {
    color: #27272a;
  }

  ul#product-list h4 {
    margin-top: 1rem;
    margin-bottom: 0.75rem;
    font-weight: 700;
    color: #4f46e5;
  }
</style>
<form id="upload-form" enctype="multipart/form-data">
  <label for="zip">Upload Products (ZIP):</label>
  <input type="file" id="zip" name="file" accept=".zip" required />
  <button type="submit">Upload</button>
</form>

<!-- Lista de productos -->
<ul id="product-list"></ul>

<script>
  async function fetchProducts(page = 1, limit = 10) {
    const list = document.getElementById("product-list");
    list.innerHTML = "<li>Loading products...</li>"; // ðŸ”¹ Mensaje temporal de carga

    try {
      const res = await fetch(
        `${API_BASE}/v1/products?page=${page}&limit=${limit}`
      );

      if (!res.ok) {
        list.innerHTML = `<li>Failed to load products. (${res.status})</li>`; // ðŸ”¹ Error HTTP en UI
        return;
      }

      const data = await res.json();

      if (
        !data.products ||
        !Array.isArray(data.products) ||
        data.products.length === 0
      ) {
        list.innerHTML = "<li>No products available.</li>"; // ðŸ”¹ Mensaje si no hay productos
        return;
      }

      list.innerHTML = "";

      data.products.forEach((product) => {
        const li = document.createElement("li");

        const variations = product.variations
          ?.map(
            (v) => `<li><strong>${v.name}:</strong> ${v.values.join(", ")}</li>`
          )
          .join("");

        const items = product.product_items
          ?.map((item) => {
            const options = item.options
              ?.map(
                (opt) =>
                  `<li>${opt.name}: ${opt.var_opt_name} ${
                    opt.var_opt_value ? `(${opt.var_opt_value})` : ""
                  }</li>`
              )
              .join("");

            return `
            <li>
              <b>Price:</b> $${item.price} | <b>Stock:</b> ${
              item.qty_in_stock
            }<br/>
              <img src="${item.img_url}" width="100"/><br/>
              <ul>${options || ""}</ul>
            </li>
          `;
          })
          .join("");

        li.innerHTML = `
          <h3>${product.name}</h3>
          <p>${product.description}</p>
          <img src="${product.img_url}" width="150" />
          <ul>${variations || ""}</ul>
          <h4>Items:</h4>
          <ul>${items || ""}</ul>
        `;

        list.appendChild(li);
      });
    } catch (error) {
      list.innerHTML = "<li>Unexpected error loading products.</li>"; // ðŸ”¹ Error de red u otro
    }
  }

  document
    .getElementById("upload-form")
    .addEventListener("submit", async (e) => {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);

      const res = await fetch(`${API_BASE}/v1/products/load-from-zip`, {
        method: "POST",
        body: formData,
      });

      if (res.ok) {
        alert("ZIP uploaded successfully!");
        await fetchProducts(); // recargar lista
      } else {
        alert("Error uploading ZIP");
      }
    });

  // Carga inicial
  fetchProducts();
</script>

{{ end }}
